syntax = "proto3";

package fund.v1;
option go_package = "github.com/og-game/game-proto/proto-gen-go/fund/v1";

import "common/v1/enum.proto";

message FundReq{

}

message FundReply{

}


//////////////////  内部RPC   //////////////////
service GameInnerService {

  // 获取单个用户余额
  rpc GetUserBalance(GetUserBalanceReq) returns (GetUserBalanceReply);

  // 批量获取用户余额
  rpc GetUserBalanceList(GetUserBalanceListReq) returns (GetUserBalanceListReply);

  // 处理交易（根据type字段处理不同类型）
  rpc ProcessTransaction(TransactionReq) returns (TransactionReply);


}

// 获取单个用户余额请求
message GetUserBalanceReq {
  int64 user_id = 1;
  int64 merchant_id = 2;
  int64 platform_id = 3;
}

// 用户余额信息
message UserBalanceInfo {
  double balance = 1; // 游戏内余额
  double frozen_balance = 2; // 游戏内冻结余额
  double transferring_balance = 3; // 转账中余额
}

// 获取单个用户余额响应
message GetUserBalanceReply {
  UserBalanceInfo balance = 1;
}

// 批量获取用户余额请求
message GetUserBalanceListReq {
  int64 user_id = 1;
  int64 merchant_id = 2;
  int64 platform_id = 3;
}

// 批量获取用户余额响应
message GetUserBalanceListReply {
  map<int64, UserBalanceInfo> balances = 1; // platform_id => UserBalanceInfo
}


// 交易请求消息
message TransactionReq {
  common.v1.TransactionType type = 1;
  int64 user_id = 2;
  int64 merchant_id = 3;
  int64 platform_id = 4;
  double amount = 5;    // 需要变动的金额 >=0
  string order_id = 6;  // 订单ID
  string description = 7; // 描述备注
  map<string, string> metadata = 8;
}

// 交易响应消息
message TransactionReply {
  bool success = 1;  // 是否成功
  string transaction_id = 2; // 账变记录ID
  double balance_before = 3; // 变更前余额
  double balance_after = 4; // 变更后余额
  int64 timestamp = 5; // 当前时间戳
}


//////////////////  暴露给API的RPC   //////////////////
service GameApiService {
  // 用户提现
  rpc Withdraw(WithdrawReq) returns (WithdrawReply);

}

// 用户提现请求
message WithdrawReq {
  int64 user_id = 1;
  double amount = 2;
  int64 platform_id = 3;
  map<string, string> extra_params = 4;
}

// 用户提现响应
message WithdrawReply {
  int32 code = 1;
  string message = 2;
  string transaction_id = 3; // 内部交易ID
  double balance = 4; // 提现后余额
  string status = 5; // 提现状态：pending, processing, completed, failed
  int64 estimated_time = 6; // 预计到账时间戳
}
